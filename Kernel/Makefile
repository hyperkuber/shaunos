


GENERAL_OPTS := -O0 -Wall 
CC_GENERAL_OPTS := $(GENERAL_OPTS) -Werror -I../Include/

CFLAGS := -c -g -nostdlib -nostdinc -fno-builtin -fno-stack-protector $(CC_GENERAL_OPTS) \
		 

C_SRCS += \
	main.c \
	console.c \
	segment.c	\
	mm.c	\
	page.c	\
	idt.c	\
	irq.c	\
	timer.c	\
	keyboard.c	\
	kthread.c	\
	tss.c	\
	syscall.c	\
	ide.c	\
	bget.c	\
	malloc.c	\
	vfs.c	\
	io_dev.c	\
	ext2.c	\
	bitops.c	\
	cpu.c	\
	elf.c	\
	time.c	\
	avltree.c	\
	pid.c	\
	int86.c	\
	video.c	\
	vesa.c	\
	pci.c	\
	mouse.c	\
	ahci.c	\
	mbuf.c	\
	e1000.c	\
	uio.c

OBJS += \
	main.o \
	console.o \
	segment.o	\
	mm.o	\
	page.o	\
	idt.o \
	irq.o	\
	trap.o	\
	timer.o	\
	irq.o	\
	keyboard.o	\
	tss.o	\
	kthread.o	\
	syscall.o	\
	ide.o	\
	bget.o	\
	malloc.o	\
	vfs.o	\
	io_dev.o	\
	ext2.o	\
	bitops.o	\
	cpu.o	\
	elf.o	\
	time.o	\
	avltree.o	\
	pid.o	\
	int86.o	\
	video.o	\
	vesa.o	\
	pci.o	\
	mouse.o	\
	ahci.o	\
	mbuf.o	\
	e1000.o	\
	uio.o

all:int86.bin elf_tramp.bin kernel.o

./%.o: ./%.c
	@gcc -S $(CC_GENERAL_OPTS) $<
	gcc $(CFLAGS)  -o$@ $<


#irq.o:irq.asm
#	@ nasm -felf irq.asm
	
trap.o:trap.asm
	@ nasm -felf trap.asm

int86.bin:
	@ nasm -fbin -o$@ int86_trampoline.asm
	@ hexdump -v -e '16/1 "%d," "\n"' int86.bin | sed 's/,,,*/,/' > int86_tramp.h

elf_tramp.bin:
	@ nasm -fbin -o$@ elf_trampoline.asm
	@ hexdump -v -e '16/1 "%d," "\n"' elf_tramp.bin | sed 's/,,,*/,/' > elf_tramp.h


kernel.o:$(OBJS) net/net.o gfx/gfx.o
	@ ld -r -o"$@" $^

net/net.o:
	@ (cd net;make)
	
gfx/gfx.o:
	@ (cd gfx;make)

clean:
	rm -rf *.o *~ *.s *.bin *.h
	@(cd net; make clean)
	@(cd gfx; make clean)
depend:
	gcc -MM -I../Include *.c | sed 's/\.c/.c/g' >> Makefile

############
#dependencies generated by
#gcc -MM -I../Include *.c | sed 's/\.c/.c/g' >> Makefile
############
console.o: console.c ../Include/kernel/console.h \
 ../Include/kernel/types.h
main.o: main.c ../Include/kernel/console.h ../Include/kernel/types.h
console.o: console.c ../Include/kernel/console.h \
 ../Include/kernel/types.h ../Include/string.h ../Include/kernel/types.h \
 ../Include/asm/io.h ../Include/asm/system.h ../Include/kernel/page.h \
 ../Include/kernel/kernel.h ../Include/kernel/mm.h \
 ../Include/kernel/multiboot.h
ide.o: ide.c ../Include/kernel/ide.h ../Include/kernel/types.h \
 ../Include/asm/io.h ../Include/kernel/kernel.h ../Include/string.h \
 ../Include/kernel/types.h
idt.o: idt.c ../Include/kernel/kernel.h ../Include/kernel/idt.h \
 ../Include/kernel/types.h
keyboard.o: keyboard.c ../Include/asm/io.h ../Include/kernel/types.h \
 ../Include/kernel/keyboard.h ../Include/kernel/kernel.h
kthread.o: kthread.c ../Include/kernel/kthread.h \
 ../Include/kernel/types.h ../Include/kernel/segment.h \
 ../Include/kernel/kernel.h ../Include/list.h ../Include/kernel/mm.h \
 ../Include/kernel/multiboot.h ../Include/string.h \
 ../Include/kernel/types.h ../Include/kernel/page.h ../Include/unistd.h \
 ../Include/kernel/tss.h
main.o: main.c ../Include/kernel/console.h ../Include/kernel/types.h \
 ../Include/string.h ../Include/kernel/types.h ../Include/asm/system.h \
 ../Include/kernel/segment.h ../Include/kernel/kernel.h \
 ../Include/kernel/mm.h ../Include/kernel/multiboot.h \
 ../Include/kernel/idt.h ../Include/kernel/timer.h ../Include/list.h \
 ../Include/kernel/keyboard.h ../Include/kernel/tss.h \
 ../Include/kernel/kthread.h ../Include/kernel/ide.h \
 ../Include/kernel/page.h
mm.o: mm.c ../Include/asm/system.h ../Include/kernel/types.h \
 ../Include/kernel/kernel.h ../Include/kernel/mm.h \
 ../Include/kernel/multiboot.h
page.o: page.c ../Include/kernel/page.h ../Include/kernel/kernel.h \
 ../Include/kernel/mm.h ../Include/kernel/types.h \
 ../Include/kernel/multiboot.h ../Include/string.h \
 ../Include/kernel/types.h
segment.o: segment.c ../Include/kernel/segment.h \
 ../Include/kernel/types.h ../Include/kernel/kernel.h ../Include/string.h \
 ../Include/kernel/types.h
syscall.o: syscall.c ../Include/kernel/syscall.h ../Include/kernel/idt.h \
 ../Include/kernel/types.h ../Include/kernel/kernel.h ../Include/unistd.h \
 ../Include/kernel/kthread.h ../Include/kernel/segment.h \
 ../Include/list.h ../Include/kernel/timer.h
timer.o: timer.c ../Include/asm/io.h ../Include/kernel/types.h \
 ../Include/kernel/timer.h ../Include/kernel/kernel.h ../Include/list.h \
 ../Include/kernel/kthread.h ../Include/kernel/segment.h
tss.o: tss.c ../Include/kernel/kernel.h ../Include/kernel/tss.h \
 ../Include/kernel/types.h ../Include/kernel/segment.h \
 ../Include/kernel/mm.h ../Include/kernel/multiboot.h
